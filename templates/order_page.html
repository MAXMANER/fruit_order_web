<!doctype html>
<html lang="en" data-bs-theme="auto">
  <head>
    <script src="{{url_for('static',filename='assets/js/color-modes.js')}}"></script>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="Mark Otto, Jacob Thornton, and Bootstrap contributors">
    <meta name="generator" content="Hugo 0.122.0">
    <title>老朱果園訂購</title>

    

    <link rel="stylesheet" href="{{ url_for('static', filename='bootstrap/css/bootstrap.min.css') }}">
    <script src="{{ url_for('static', filename='jquery-3.7.1.min.js') }}" type="text/javascript"></script>
    <script src="{{ url_for('static', filename='bootstrap/js/bootstrap.bundle.min.js') }}"></script>
    <link href="{{url_for('static',filename='assets/dist/css/bootstrap.min.css')}}" rel="stylesheet">

    <style>
        .template-group {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            background-color: #f9f9f9;
        }

        .template-group:nth-child(odd) {
            background-color: #e9f7fd; /* Light blue for odd groups */
        }

        .template-group:nth-child(even) {
            background-color: #f4e9fd; /* Light purple for even groups */
        }
      .bd-placeholder-img {
        font-size: 1.125rem;
        text-anchor: middle;
        -webkit-user-select: none;
        -moz-user-select: none;
        user-select: none;
      }

      @media (min-width: 768px) {
        .bd-placeholder-img-lg {
          font-size: 3.5rem;
        }
      }

      .b-example-divider {
        width: 100%;
        height: 3rem;
        background-color: rgba(0, 0, 0, .1);
        border: solid rgba(0, 0, 0, .15);
        border-width: 1px 0;
        box-shadow: inset 0 .5em 1.5em rgba(0, 0, 0, .1), inset 0 .125em .5em rgba(0, 0, 0, .15);
      }

      .b-example-vr {
        flex-shrink: 0;
        width: 1.5rem;
        height: 100vh;
      }

      .bi {
        vertical-align: -.125em;
        fill: currentColor;
      }

      .nav-scroller {
        position: relative;
        z-index: 2;
        height: 2.75rem;
        overflow-y: hidden;
      }

      .nav-scroller .nav {
        display: flex;
        flex-wrap: nowrap;
        padding-bottom: 1rem;
        margin-top: -1px;
        overflow-x: auto;
        text-align: center;
        white-space: nowrap;
        -webkit-overflow-scrolling: touch;
      }

      .btn-bd-primary {
        --bd-violet-bg: #712cf9;
        --bd-violet-rgb: 112.520718, 44.062154, 249.437846;

        --bs-btn-font-weight: 600;
        --bs-btn-color: var(--bs-white);
        --bs-btn-bg: var(--bd-violet-bg);
        --bs-btn-border-color: var(--bd-violet-bg);
        --bs-btn-hover-color: var(--bs-white);
        --bs-btn-hover-bg: #6528e0;
        --bs-btn-hover-border-color: #6528e0;
        --bs-btn-focus-shadow-rgb: var(--bd-violet-rgb);
        --bs-btn-active-color: var(--bs-btn-hover-color);
        --bs-btn-active-bg: #5a23c8;
        --bs-btn-active-border-color: #5a23c8;
      }

      .bd-mode-toggle {
        z-index: 1500;
      }

      .bd-mode-toggle .dropdown-menu .active .bi {
        display: block !important;
      }
      .spacer {
            height: 50px; /* Adjust this value to increase or decrease the space */
      }
    </style>

    
    <!-- Custom styles for this template -->
    <link href="{{url_for('static',filename='checkout.css')}}" rel="stylesheet">
  </head>
  <body class="bg-body-tertiary">
    <svg xmlns="http://www.w3.org/2000/svg" class="d-none">

<div class="container">
  <main>
    <div class="py-5 text-center">
      <img class="d-block mx-auto mb-4" src="../static/img/logo.png" alt="" width="100" height="114">
      <h2>訂購單</h2>
    </div>
 
      <div class="col-md-7 col-lg-8">
        <h4 class="mb-3" style="color:red">今年文旦柚已全數銷售完畢，想吃柚子的朋友，明年可以提早預購喔!</h4>
        <form id="dataForm" class="needs-validation" action="{{url_for('qrcode_page')}}" method="get">
          <div id="input-container">
          <div class="row g-3 template-group" id="template-group">
            <table class="shop_table" cellspacing="0">    
              <tbody><tr class="product-item ">
                  <td class="product-name">特級文旦柚(十斤/13~16入)</td>
                  <td class="product-price">
                      <span itemprop="price" class="price"><span class="woocommerce-Price-amount amount"><span class="woocommerce-Price-currencySymbol">NT$</span>760</span> <ins><del><span class="woocommerce-Price-amount amount"><span class="woocommerce-Price-currencySymbol">NT$</span>800</span></del></ins></span>
                  </td>
      
                  <td class="product-quantity">
                  <div class="input-group">
                    <button type="button" class="btn btn-danger btn-number decrement-button"  data-type="minus" data-field="item1_quantity">-</button>
                <input type="number" id="item1_quantity" name="item1_quantity" class="form-control input-number input-item1" value="0" min="0" max="{{item1_max_quantity}}">
                    <button type="button" class="btn btn-success btn-number increment-button" data-type="plus" data-field="item1_quantity">+</button>
                    <span id="remaining_quantity1" class="remaining-quantity1">剩餘 {{item1_max_quantity}}</span>
            </div>
                  </td>
              </tr>
          
              <tr class="product-item ">
      
      
                  <td class="product-name">優級文旦柚(十斤/10~12入)</td>
      
                  <td class="product-price">
                      <span itemprop="price" class="price"><span class="woocommerce-Price-amount amount"><span class="woocommerce-Price-currencySymbol">NT$</span>570</span> <ins><del><span class="woocommerce-Price-amount amount"><span class="woocommerce-Price-currencySymbol">NT$</span>600</span></del></ins></span>
                  </td>
      
                  <td class="product-quantity">
                 <div class="input-group">
                  <button type="button" class="btn btn-danger btn-number decrement-button"  data-type="minus" data-field="item2_quantity">-</button>
                <input type="number" id="item2_quantity"name="item2_quantity" class="form-control input-number input-item2" value="0" min="0" max="{{item2_max_quantity}}">
                  <button type="button" class="btn btn-success btn-number increment-button" data-type="plus" data-field="item2_quantity">+</button>
                  <span id="remaining_quantity2"  class="remaining-quantity2" >剩餘 {{item2_max_quantity}}</span>
                </div>
                  </td>
              </tr>
          </tbody></table>
            <div class="col-md-5 col-lg-4">
              <h2>收件人</h2>
                <div class="col-sm-6">
                  <label for="receiverName" class="form-label">姓名</label>
                  <input type="text" class="form-control input-receiver" id="receiverName" name ="recipient_name" placeholder="" value="{{user_name}}" required>
                  <div class="invalid-feedback">
                    請填寫收件人姓名.
                  </div>
                </div>

                <div class="col-sm-7">
                  <label for="receiverPhone" class="form-label">聯絡電話</label>
                  <input type="text" class="form-control input-receiver" id="receiverPhone" name="recipient_phone" placeholder="" required>
                  <div class="invalid-feedback">
                    請填寫收件人姓名.
                  </div>
                </div>

                <div class="col-12">
                  <label for="receiveraddress" class="form-label">地址</label>
                  <input type="text" class="form-control input-receiver" id="receiveraddress" name="recipient_address" placeholder="" required>
                  <div class="invalid-feedback">
                    請輸入收件人地址.
                  </div>
                </div>
            
              <hr class="my-4">

              <h2>送禮人</h2>
              <p class="lead">若是送禮需求請留下您的大名、電話，方便收禮人確認.</p>
              <div class="col-sm-6">
                <label for="senderName" class="form-label">姓名</label>
                <input type="text" class="form-control input-sender" id="senderName" name="sender_name" placeholder="" value="{{sender_name}}" >
                <div class="invalid-feedback">
                  請填寫送禮人姓名(選填)
                </div>
              </div>

              <div class="col-sm-7">
                <label for="senderPhone" class="form-label">聯絡電話</label>
                <input type="text" class="form-control input-sender" id="senderPhone" name="sender_phone" placeholder="" value="{{sender_phone}}" >
                <div class="invalid-feedback">
                  請填寫送禮人電話(選填)
                </div>
              </div>
            </div>
            <div class="spacer"></div>
          </div>
        </div>
            <button type="button" class="btn btn-primary" id="add-group-button">再新增一筆</button>

            <h4 class="d-flex justify-content-between align-items-center mb-3">
              <span class="text-primary">購物車</span>
              <span id="total-quantity"class="badge bg-primary rounded-pill">0</span>
            </h4>
            <ul class="list-group mb-3">
              <li class="list-group-item d-flex justify-content-between lh-sm">
                <div>
                  <h6 class="my-0">特級文旦</h6>
                  <small class="text-body-secondary" id="item1-quantity">*0</small>
                </div>
                <span>$<span class="text-body-secondary" id="item1-price">0</span></span>
              </li>
              <li class="list-group-item d-flex justify-content-between lh-sm">
                <div>
                  <h6 class="my-0">優級文旦</h6>
                  <small class="text-body-secondary" id="item2-quantity">*0</small>
                </div>
                <span>$<span class="text-body-secondary" id="item2-price">0</span></span>
              </li>
              <li class="list-group-item d-flex justify-content-between bg-body-tertiary">
                <div class="text-success">
                  <h6 class="my-0">優惠</h6>
                  <small>首購優惠</small>
                </div>
                <span>−$<span class="text-success" id="discount">0</span></span>
              </li>
              <li class="list-group-item d-flex justify-content-between">
                <span>總金額</span>
                <span>$<strong id="total_price" name="total_price">0</strong></span>
              </li>
            </ul>

              <input type="hidden" id="user_id" name="user_id" value="{{user_id}}" />
              <button class="w-100 btn btn-primary btn-lg" type="submit" value="Submit">送出訂單</button>
            </form>
          </div>
        </div>
        <div class="spacer"></div>
      </main>

      <script src="{{url_for('static',filename='assets/dist/js/bootstrap.bundle.min.js')}}"></script>

<script>

$(document).ready(function() {
    $('.input-number').on('change keyup', function() {
      let sum = 0;
      console.log("change");
      if($(this).attr('id') =='item1_quantity'){
            $('input.input-item1').each(function() {
            let value = parseFloat($(this).val());
            if (!isNaN(value)) {
                sum += value;
            }
          });
      }
      else if($(this).attr('id') =='item2_quantity'){
            $('input.input-item2').each(function() {
            let value = parseFloat($(this).val());
            if (!isNaN(value)) {
                sum += value;
            }
          });
      }
        console.log('Total sum: ' + sum);
        let min = parseInt($(this).attr('min'));
        let max = parseInt($(this).attr('max'));
        let value = parseInt($(this).val());
        if (value < min) {
            $(this).val(min);
        } else if (sum > max) {
            $(this).val(0);
        }

        updateTotal();
    });
   function updateTotal() {
        console.log("updateTotal");
        let total = 0;
        let item1_quantity = 0;
        let item2_quantity = 0;
        let discount=0;
        let maxQuantities = {
            item1: {{ item1_max_quantity }},
            item2: {{ item2_max_quantity }}
        };
        $('.template-group').each(function() {
            $(this).find('.input-group').each(function(index) {
                let input = $(this).find('.input-number');
                let value = parseInt(input.val()) || 0;
                if (index === 0) {
                    item1_quantity += value; // First set multiplier
                } else if (index === 1) {
                    item2_quantity += value; // Second set multiplier
                }
            });
        });
        discount = (item1_quantity * 40) + (item2_quantity * 30);
        total_price = (item1_quantity * 800)+(item2_quantity * 600) - discount
        $('#total-quantity').text(item1_quantity + item2_quantity);
        $('#item1-price').text(item1_quantity * 800);
        $('#item1-quantity').text(item1_quantity+"箱");
        $('#item2-price').text(item2_quantity * 600);
        $('#item2-quantity').text(item2_quantity+"箱");
        $('#discount').text(discount);
        $('#total_price').text(total_price);
        $('.remaining-quantity1').text(`剩餘 ${maxQuantities.item1 - item1_quantity}`);
        $('.remaining-quantity2').text(`剩餘 ${maxQuantities.item2 - item2_quantity}`);
        //$('.input-item1').attr('max',maxQuantities.item1 - item1_quantity);
        //$('.input-item2').attr('max',maxQuantities.item2 - item2_quantity);
        $('#total-sum').text(total);
        }

  function updateValue(input, isIncrement) {
      let currentValue = parseInt(input.val());
      let newValue = isIncrement ? currentValue + 1 : currentValue - 1;
      console.log("updateValue");
      input.val(newValue).trigger('change');
    }
  function validateGroupQuantities() {
          let valid = true;
          $('.template-group').each(function() {
              let item1Qty = parseInt($(this).find("input[name='item1_quantity']").val()) || 0;
              let item2Qty = parseInt($(this).find("input[name='item2_quantity']").val()) || 0;

              if (item1Qty + item2Qty <= 0) {
                  valid = false;
                  $(this).css("border", "2px solid red"); // Highlight invalid group
                  alert("請確認每組的訂購數量總和大於0。");
              } else {
                  $(this).css("border", "1px solid #ccc"); // Reset border for valid groups
              }
          });
          return valid;
      }
// Event handler for decrement buttons

$(document).on('click', '.decrement-button', function() {
    let input = $(this).siblings('.input-number');
    updateValue(input, false);
});

// Event handler for increment buttons
$(document).on('click', '.increment-button', function() {
    let input = $(this).siblings('.input-number');
    updateValue(input, true);
});

$('.input-number').focusin(function(){
   $(this).data('oldValue', $(this).val());
});

    $(".input-number").keydown(function (e) {
        // Allow: backspace, delete, tab, escape, enter and .
        if ($.inArray(e.keyCode, [46, 8, 9, 27, 13, 190]) !== -1 ||
             // Allow: Ctrl+A
            (e.keyCode == 65 && e.ctrlKey === true) || 
             // Allow: home, end, left, right
            (e.keyCode >= 35 && e.keyCode <= 39)) {
                 // let it happen, don't do anything
                 return;
        }
        // Ensure that it is a number and stop the keypress
        if ((e.shiftKey || (e.keyCode < 48 || e.keyCode > 57)) && (e.keyCode < 96 || e.keyCode > 105)) {
            e.preventDefault();
        }
    });
    $('#add-group-button').click(function() {
                let originalGroup = $('#template-group').last();
                let newGroup = originalGroup.clone(true);
                newGroup.find('.input-number').val(0); // Reset input values to 0
                newGroup.find('.input-receiver').val('');
                newGroup.appendTo('#input-container');
            });

    
    $('#dataForm').on('submit', function(event) {
                event.preventDefault(); // Prevent the default form submission
                if (!validateGroupQuantities()) {
                            return;
                        }
                // Serialize the form data
                 let groups = [];
                $('.template-group').each(function(index) {
                  let group = {
                    groupId: index + 1,
                    item1_quantity: parseInt($(this).find("input[name='item1_quantity']").val()) || 0,
                    item2_quantity: parseInt($(this).find("input[name='item2_quantity']").val()) || 0,
                    recipient_name: $(this).find("input[name='recipient_name']").val(),
                    recipient_phone: $(this).find("input[name='recipient_phone']").val(),
                    recipient_address: $(this).find("input[name='recipient_address']").val(),
                    sender_name: $(this).find("input[name='sender_name']").val(),
                    sender_phone: $(this).find("input[name='sender_phone']").val(),
                    total_price: (parseInt($(this).find("input[name='item1_quantity']").val()) || 0)*760+(parseInt($(this).find("input[name='item2_quantity']").val()) || 0)*570
                  };
                  groups.push(group);
                });
                let data = {
                  user_id: '{{user_id}}',
                  user_name: '{{user_name}}',
                  groups: groups
                };
              console.log(JSON.stringify(data));
              // Send an AJAX request to the server-side script
              
              $.ajax({
                  type: 'POST',
                  url: '{{save_data_url}}/save_data',
                  contentType: 'application/json',
                  data: JSON.stringify(data),
                  success: function(response) {
                      alert('訂單已成立');
                      event.target.submit();
                  },
                  error: function(jqXHR, textStatus, errorThrown) {
                      alert('訂單成立失敗，請聯絡我們');
                  }
              });           
          });
            
        });

  </script>
    <script src="{{url_for('static',filename='checkout.js')}}"></script>
  </body>
</html>
